<!DOCTYPE html>
<html>
<head>
    <title>Test Single Finance Signup</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Single Finance Manager Signup</h1>
    
    <div id="result"></div>
    
    <form id="testForm">
        <label>Email: <input type="email" id="email" value="test123@example.com" required></label><br><br>
        <label>First Name: <input type="text" id="firstName" value="Test" required></label><br><br>
        <label>Last Name: <input type="text" id="lastName" value="User" required></label><br><br>
        <label>Phone: <input type="text" id="phone" value="555-123-4567" required></label><br><br>
        <button type="submit">Test Signup</button>
    </form>

    <script>
        const supabaseUrl = 'https://iugjtokydvbcvmrpeziv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z2p0b2t5ZHZiY3ZtcnBleml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MTk3NjUsImV4cCI6MjA2MTI5NTc2NX0.XCNQoJbGQiXuyR_CFevro1Y8lqvh2_jmjrD181UYtY4';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message) {
            const result = document.getElementById('result');
            result.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        function generateTempPassword() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            const fullName = `${firstName} ${lastName}`;
            const tempPassword = generateTempPassword();

            log(`üöÄ Starting signup for: ${email}`);

            try {
                // Step 1: Create signup request
                log('üìù Creating signup request...');
                const { data: signupData, error: signupError } = await supabase
                    .from('signup_requests')
                    .insert({
                        email: email,
                        dealership_name: `${fullName} - Finance Manager`,
                        contact_person: fullName,
                        phone: phone,
                        tier: 'finance_manager',
                        subscription_tier: 'finance_manager_free_promo',
                        dealer_count: 1,
                        add_ons: [],
                        promo_applied: true,
                        status: 'approved',
                        stripe_payment_status: 'free_promotional',
                    })
                    .select()
                    .single();

                if (signupError) {
                    log(`‚ùå Signup request error: ${signupError.message}`);
                    return;
                }

                log(`‚úÖ Signup request created: ID ${signupData.id}`);

                // Step 2: Create auth user
                log('üë§ Creating auth user...');
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: tempPassword,
                    options: {
                        data: {
                            full_name: fullName,
                            first_name: firstName,
                            last_name: lastName,
                            phone: phone,
                            role: 'single_finance_manager',
                            signup_request_id: signupData.id,
                        },
                    },
                });

                if (authError) {
                    log(`‚ùå Auth error: ${authError.message}`);
                    return;
                }

                log(`‚úÖ Auth user created: ${authData.user?.id}`);

                // Step 3: Auto sign-in
                log('üîê Auto-signing in...');
                const { error: signInError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: tempPassword,
                });

                if (signInError) {
                    log(`‚ùå Sign-in error: ${signInError.message}`);
                } else {
                    log(`‚úÖ Successfully signed in!`);
                    log(`üìß Email: ${email}`);
                    log(`üîë Password: ${tempPassword}`);
                    log(`üéâ Ready to redirect to: /dashboard/single-finance`);
                }

            } catch (error) {
                log(`üí• Exception: ${error.message}`);
            }
        });

        // Test the connection
        supabase.from('roles').select('count').limit(1).then(({ data, error }) => {
            if (error) {
                log(`‚ùå Connection test failed: ${error.message}`);
            } else {
                log('‚úÖ Supabase connection successful');
            }
        });
    </script>
</body>
</html>